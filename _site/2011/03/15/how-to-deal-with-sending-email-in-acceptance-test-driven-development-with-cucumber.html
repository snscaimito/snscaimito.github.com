<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>How to deal with sending email in Acceptance Test Driven Development with Cucumber</title>
	
	<link rel="canonical" href="http://0.0.0.0:4000/2011/03/15/how-to-deal-with-sending-email-in-acceptance-test-driven-development-with-cucumber.html"/>
	
	<link rel="stylesheet" href="/css/bootstrap.min.css" type="text/css" />
	<link rel="stylesheet" href="/css/syntax.css" type="text/css" />
	<link rel="stylesheet" href="/css/schwab.css" type="text/css" />
	<link rel="stylesheet" href="/css/print.css" media="print" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans+Condensed|Sansita:700|Zilla+Slab" rel="stylesheet">
	
	<link rel="alternate" type="application/rss+xml" title="Stephan Schwab" href="/rss.xml"/>

	<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
	<script type='text/javascript' src='/unitegallery/js/unitegallery.min.js'></script> 
		
	<link rel='stylesheet' href='/unitegallery/css/unite-gallery.css' type='text/css' /> 
	<script type='text/javascript' src='/unitegallery/themes/tiles/ug-theme-tiles.js'></script> 

	<meta property="og:title" content="How to deal with sending email in Acceptance Test Driven Development with Cucumber">
	<meta property="twitter:title" content="How to deal with sending email in Acceptance Test Driven Development with Cucumber">
	<meta property="og:description" content="">
	<meta property="twitter:description" content="">
	<meta property="og:type" content="article">
	<meta property="og:url" content="http://0.0.0.0:4000/2011/03/15/how-to-deal-with-sending-email-in-acceptance-test-driven-development-with-cucumber.html">
	<meta property="twitter:card" content="summary_large_image">
	<meta property="twitter:site" content="@snscaimito">
	
</head>


<body>
	<div class="container">
		<div class="header no-print">
  <div class="menu">
    <a href="/">Home</a>
    <a href="/category/software_development.html">Software</a>
    <a href="/category/farm-life.html">Farm Life</a>
    <a href="/category/Business.html">Business</a>
    <a href="/category/aviation.html">Aviation</a>
  </div>
  <div class="claim-box">
    <p class="claim">Tales about Aviation, Coaching, Farming, Software Development</p>
  </div>
</div>
		<div class="row">
			<div class="span9">
				<div class="post">
					<h1>How to deal with sending email in Acceptance Test Driven Development with Cucumber</h1>
          <p>At times one needs to think a bit harder about how to test something when it goes beyond interacting with web pages or other types of user interfaces. That is usually the case when one system interacts with another. I’d like to share one such case and explain my solution to the problem.</p>

<p>Given there is an application that allows users to register and then they get an email that contains a link that needs to be followed to confirm the reception of said email.</p>

<p>So that states the problem. There are several ways to solve it.</p>

<p>a) use some external mail service and access it via POP3 or IMAP from your Cucumber scripts</p>

<p>b) configure your own internal mail service with mailboxes and then access it via POP3 or IMAP from your Cucumber scripts</p>

<p>c) make the application under test be test-aware and have it write emails to a file instead of using the SMTP transport</p>

<p>Originally I was using MRI Ruby and used approach a). My external mail server was GMail and I accessed it via secure IMAP. For that I had written a simple class that logs into GMail, finds the email of interest, reads the body to find the URL for the link to be followed and then cleaned up by deleting the email. That was little effort and worked very well.</p>

<p>A while later I switched to JRuby because I wanted to use the Maven plugin for Cucumber to run all my acceptance tests as part of the Maven build. The application under test is written in Java. My ultimate goal was to deploy a well tested artifact directly from Maven so that I can start doing continuous deployment to production.</p>

<p>After switching from MRI Ruby to JRuby I noticed that I was now unable to connect to GMail due an issue with the validation of SSL certificates. I tried shortly to tell JRuby to accept whatever the other site presents but then I started to rethink my whole approach.</p>

<p>Why should my acceptance test depend on an external service like GMail? A service I don’t control. A service that can be down in the middle of something important and urgent.</p>

<p><strong>Sure I can turn my laptop into a mail server - but do I need to?</strong></p>

<p>I’m working on Mac OS X and there is already Postfix as MTA (message transfer agent) installed. I was using it already to send email from the application. As I have extensive experience in running mail servers from “a former life” (I used to run an Internet Service Provider in the late 1990s) that should not be problem. Quickly I typed <code>sudo ports install cyrus-imapd</code> and then it dawned me that there has to be an easier way than to set up a full-blown email service on my laptop.</p>

<p><strong>No need to test external systems</strong></p>

<p>There is no law that says your application always needs to do the real thing or talk to any external system for real. All we want is the acceptance criteria to be met and do that in a test that is reasonable enough to show that the application is behaving correctly. In my case it was not at all about proving the ability to actually deliver an email to a place beyond my laptop.</p>

<p><strong>What I did</strong></p>

<p>In the Java code a <code>MimeMessage</code> gets prepared and then handed over to JavaMail for delivery. The delivery takes place by calling <code>Transport.send(message)</code>. That was my opportunity. It is a simple method call and who said I can’t call something I created and in there I can either send the email by calling <code>Transport.send(message)</code> or write the full email to a file …</p>

<p>Luckily JavaMail already has the ability to print a message to an OutputStream. So with a simple <code>message.writeTo(new FileOutputStream(messageFile))</code> it ends up in a text file.</p>

<p>On the Ruby side in my Cucumber script I use <code>filename = "/tmp/test-#{expected_recipient}"</code> to look for emails in files. Under test my application writes files like <code>/tmp/test-sns@caimito.net</code>. The rest of my already existing Ruby code that looks for the confirmation link in those emails works unchanged.</p>

<p>Further I was able to remove a wait period from my script. That wait period was necessary because the delivery of an email to an actual mail service (much so when using an external service) can take a while. Now all my scenarios that deal with email run as fast as possible without any delay.</p>

<p><strong>Build applications that are test aware</strong></p>

<p>As this example shows sometimes it is necessary that the application under test cooperates and is aware of the fact that it runs under test. As I mentioned I am using the Cucumber plugin for Maven. This runs Cucumbers during the integration test phase. In the pre integration test phase Maven starts up Tomcat and deploys the application to it. I let the application know that it now runs under test and that tells my IoC container to use different implementations at the edges. One is the one described here.</p>

<p>In production nothing gets changed at the edges and the application talks to the real external systems.</p>

<p><strong>But isn’t it dangerous to change the application while under test?</strong></p>

<p>Yes, it can be. But in my opinion it is much more dangerous not to have clear acceptance criteria and not test enough. There is some remaining risk which can be mitigated by not deploying new code to a large server cluster all at once but instead roll out new code gradually. There have been articles about large web sites where such a gradual rollout is being used successfully.</p>

					<table class="postfooter" style="width: 100%">
					<tr>
						<td style="text-align: left; width: 33%"><a href="/2011/03/11/dont-tie-cucumber-features-11-to-stories.html">Previous</a></td>
						<td style="text-align: center; width: 33%">15 Mar 2011</td>
						<td style="text-align: right; width: 33%"><a href="/2011/03/19/acceptance-test-driven-development-changes-how-you-organize-your-project.html">Next</a></td>
					</tr>
					</table>
					<p>This article has been posted to social media sites. There might be comments. Just follow the links:</p>
					<div>
						<a class="social-blogging" service="twitter" href="https://twitter.com/snscaimito"><img src="/img/Furry-Cushion-Twitter_48.png" /></a>
						<a class="social-blogging" service="activityPub" rel="me" href="https://techhub.social/@snscaimito"><img src="/img/mastodon.svg" width="48" /></a>
					</div>
				</div>
			</div>
			<div class="span3">
        <div class="sidebar">
        	<p class="section">About this article</p>
          <p>Published: March 15, 2011</p>
					<p>Posted in:
						
							<a class="categoryLink" href="/category/software_development.html">software_development</a>
						
							<a class="categoryLink" href="/category/atdd.html">atdd</a>
						
							<a class="categoryLink" href="/category/quality.html">quality</a>
						
					</p>
          
        </div>
				<div class="sidebar">
	<p class="section">About me</p>
	<p>Hello! My name is <a href="/">Stephan Schwab</a>.</p>
			<a href="/"><img src="http://www.gravatar.com/avatar/663d11426b0a187ddac59f8c17ce61b4?s=90" class="align-left"/></a>
		<p>As International Software Development Coach and Consultant I help CEOs and Department Leaders to <strong>improve</strong> <strong>value creation</strong> and <strong>cohesion</strong> within their organization. The outcome will be higher <strong>quality</strong>, <strong>customer delight</strong> and <strong>more revenue</strong>.</p> 
		
		<p>Learn about <a href="/resume/">my professional experience</a> since 1986.</p>
    <span style="clear:both; float:none"/>

	<p class="section">Professional Services</p>
	<p>I'm fluent in these languages:</p>
	<p align="center">
		<a href="/category/en.html"><img src="/img/language-flags/32x32/flag_rotate-02.png"></a>
		<a href="/category/de.html"><img src="/img/language-flags/32x32/flag_rotate-03.png"></a>
		<a href="/category/es.html"><img src="/img/language-flags/32x32/flag_rotate-12.png"></a>
	</p>
	<p align="center">
		<small>
			<a href="/category/en.html">English</a>
			<a href="/category/de.html">German</a>
			<a href="/category/es.html">Spanish</a>
		</small>
	</p>
	<div class="no-print-sidebar">
		<p>Scrum Pair-Coaching to develop technical competence:</p>
		<p align="center">Details in <a href="/en-pair-coaching-scrummaster.html">English</a>, <a
				href="/de-pair-coaching-scrummaster.html">Deutsch</a></p>

		<p><strong>Resources for new clients</strong>:</p>
		<p align="center"><a href="/resources/de-new-client.html">Deutsch</a></p>
	</div>

	<div class="no-print-sidebar">
		<p class="section noprint">Search</p>
		<form method="get" action="http://www.google.com/search">
			<p align="center"><input type="text" name="q" maxlength="255" value="" style="width: 180px" /></br>
				<input type="submit" value="Google Search" class="btn btn-primary btn-mini" />
			</p>
			<input type="hidden" name="sitesearch" value="http://www.stephan-schwab.com" />
		</form>

		<p class="section">Special&nbsp;Content</p>
		<ul class="special-content">
			<li><a href="/atdd/">Acceptance Test-Driven Development</a></li>
			<li><a href="/software-design/">Software Design</a></li>
			<li><a href="/sddm.html">Software Development Decision Making</a></li>
		</ul>
		<ul class="special-content">
			<li><a href="/coaching-future-masters.html">Coaching future masters</a></li>
		</ul>
		<ul class="special-content">
			<li><a href="/farmstead.html">Developing a farmstead in Andalucia, Spain</a></li>
			<li><a href="/house/">Building a house, Spain</a></li>
			<li><a href="/airtravel/">Business travel with light aircraft</a></li>
			<li><a href="/horses/">Horses</a></li>
			<li><a href="/panama-farm.html">Rainforest Farm, Panama</a></li>
			<li><a href="/galleries/">Photo Galleries</a></li>
		</ul>
		<ul class="special-content">
			<li><a href="/reading-list.html">My reading list</a></li>
		</ul>

		<p class="section">Highlights of the Year</p>
		<ul class="special-content">
			
			<li><a href="/2016/12/27/highlights-of-2016.html">2016</a></li>
			
			<li><a href="/2015/12/31/highlights-2015.html">2015</a></li>
			
			<li><a href="/2014/12/31/highlights-2014.html">2014</a></li>
			
			<li><a href="/2013/12/31/hightlights-2013.html">2013</a></li>
			
			<li><a href="/2012/12/31/highlights-2012.html">2012</a></li>
			
			<li><a href="/2011/12/31/highlights-2011.html">2011</a></li>
			
			<li><a href="/2010/12/31/highlights-2010.html">2010</a></li>
			
			<li><a href="/2009/12/31/highlights-2009.html">2009</a></li>
			
			<li><a href="/2008/12/31/highlights-2008.html">2008</a></li>
			
			<li><a href="/2007/12/31/highlights-2007.html">2007</a></li>
			
			<li><a href="/2006/12/31/highlights-2006.html">2006</a></li>
			
		</ul>

		<p class="section">Living on planet Earth</p>
		<ul class="special-content">
			<li><a href="/dominican-republic.html">Dominican Republic</a></li>
			<li><a href="/china.html">China</a></li>
			<li><a href="/germany.html">Germany</a></li>
			<li><a href="/panama.html">Panama</a></li>
			<li><a href="/spain.html">Spain</a></li>
			<li><a href="/usa.html">USA</a></li>
		</ul>

		<p class="section">Open Source Projects</p>
		<ul class="special-content">
			<li><a href="/ale-news.html">Development of ALE News</a></li>
			<li><a href="https://github.com/snscaimito/RAutomation">RAutomation</a></li>
			<li><a href="/open-source.html">Other contributions to Open Source</a></li>
		</ul>

		<p class="section">Stay in touch</p>
		<p align="center">
			<a href="/rss.xml"><img src="/img/Furry-Cushion-RSS_48.png" /></a>
			<a href="https://twitter.com/snscaimito"><img src="/img/Furry-Cushion-Twitter_48.png" /></a>
			<a href="http://www.linkedin.com/in/stephanschwab"><img src="/img/Furry-Cushion-LinkedIn_48.png" /></a>
		</p>
		<p align="center">
			<a rel="me" href="https://techhub.social/@snscaimito"><img src="/img/mastodon.svg" width="48" /></a>
			<a href="https://bsky.app/profile/snscaimito.bsky.social"><img src="/img/Bluesky_butterfly-logo.svg"
					width="65" /></a>
			<a href="https://www.tiktok.com/@snscaimito"><img src="/img/tiktok-icon-white-1-logo-svgrepo-com.svg"
					width="48" /></a>
		</p>
		<p align="center">
			<a href="mailto:sns@caimito.net?subject=From%20stephan-schwab.com">sns@caimito.net</a>
		</p>

		<p class=" section">My Books
		</p>
		<p align="center"><a href="https://leanpub.com/activitycentereddesign"><img
					src="/img/smarter-software-with-activity-centered-design.jpg" /></a></p>
		<p align="center"><a href="https://leanpub.com/essays-on-software-development-2012"><img
					src="/img/essays-on-software-development-2012.png" /></a></p>

		<p class="section">Everything</p>
		<p>See a listing of <a href="/all-posts.html">all posts</a> on this site.</p>
	</div>
</div>
			</div>
		</div>
	</div>
		<script src="//use.typekit.net/npx1yoc.js"></script>
	<script>try{Typekit.load();}catch(e){}</script>
	
	<script type="text/javascript" src="/js/bootstrap.min.js"></script>

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-35257032-1', 'auto');
	  ga('require', 'displayfeatures');
	  ga('send', 'pageview');

	</script>
	<script type="text/javascript"> 
		jQuery(document).ready(function(){ 
			jQuery("#gallery").unitegallery(); 
		}); 
	</script>
	
	<script>
		$(document).ready(function() {
			$('.social-blogging').each(function() {
				const service = $(this).attr('service');
				const url = `/api/posted-on/${service}?article=${window.location.pathname}`;

				fetch(url)
					.then(response => response.json())
					.then(data => {
						console.log(data)
						$(this).attr('href', data.postUrl)
					})
					.catch(error => console.error('Error:', error));
			})
		})
	</script>

</body>
</html>
